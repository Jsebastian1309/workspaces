<div class="list-view" *ngIf="list; else empty">
  <!-- Header with list info + actions on the right -->
  <div class="header d-flex justify-content-between align-items-start">
    <div class="list-info flex-grow-1">
      <h2 class="title mb-1">{{ list.nombre }}</h2>
      <p class="desc mb-0" *ngIf="list.descripcion">{{ list.descripcion }}</p>
    </div>

    <!-- Actions on the right -->
    <div class="actions ms-3">
      <div class="btn-group">
        <button
          class="btn btn-outline-secondary btn-sm"
          (click)="openApplyModal()">
          <i class="bi bi-file-earmark-plus"></i> Apply template
        </button>
        <button
          class="btn btn-primary btn-sm"
          (click)="openSaveModal()">
          <i class="bi bi-save"></i> Save as template
        </button>
      </div>
    </div>
  </div>

  

  <!-- Estados de carga y error -->
  <div class="status-message">
    <div class="loading" *ngIf="loading">Cargando tareas...</div>
    <div class="error" *ngIf="!loading && error">{{ error }}</div>
    <div class="success" *ngIf="!loading && info">{{ info }}</div>
  </div>

  <!-- Tablas agrupadas por estado con funcionalidad de colapsar -->
  <div class="accordion" id="tasksAccordion">
    <ng-container *ngFor="let status of getVisibleStatuses(); let i = index">
      <div class="accordion-item">
        <h2 class="accordion-header" id="heading{{ i }}">
          <button class="accordion-button" type="button"
                  [attr.aria-expanded]="!isCollapsed(status.key)"
                  [attr.aria-controls]="'collapse' + i"
                  [style.background-color]="getStatusColor(status.key)"
                  (click)="toggleCollapse(status.key)">
            {{ status.label }}
          </button>

        </h2>
        <div
          id="collapse{{ i }}"
          class="accordion-collapse collapse"
          [attr.aria-labelledby]="'heading' + i"
          data-bs-parent="#tasksAccordion"
          [class.show]="!isCollapsed(status.key)"
        >
          <div class="accordion-body">
            <div class="table-h-scroll">
            <table class="table wide-table sticky-header">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Descripción</th>
                  <th>Estado</th>
                  <th>Progreso</th>
                  <th>Prioridad</th>
                  <th>Fecha Inicio</th>
                  <th>Fecha Fin</th>
                  <th>Fecha Vencimiento</th>
                  <th>Duración Horas</th>
                  <th>Fecha Creación</th>
                  <th>Fecha Cerrada</th>
                  <th>Fecha Terminada</th>
                  <th>Asignado A</th>
                  <th>Facturable</th>
                  <th>Comentarios</th>
                  <th>Etiqueta</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <!-- Add-row: visible when adding for this status -->
                <tr *ngIf="addingFor === status.key" class="add-row">
                  <td>
                    <input class="input" placeholder="Nombre de la tarea" [value]="draft.nombre || ''" (input)="draft.nombre = $any($event.target).value" />
                  </td>
                  <td>
                    <input class="input" placeholder="Descripción" [value]="draft.descripcion || ''" (input)="draft.descripcion = $any($event.target).value" />
                  </td>
                  <td>
                    <!-- Estado desde template de estados -->
                    <select class="select" [value]="draft.estado || status.key" (change)="draft.estado = $any($event.target).value">
                      <option *ngFor="let s of statuses" [value]="s.key">{{ s.label }}</option>
                    </select>
                  </td>
                  <td>
                    <input class="input" type="number" min="0" max="100" [value]="draft.progreso || 0" (input)="draft.progreso = ($any($event.target).valueAsNumber ?? 0)" />
                  </td>
                  <td>
                    <!-- Dropdown prioridad estilo filtro -->
                    <div ngbDropdown class="dropdown-select w-100">
                      <button class="btn btn-select btn-sm dropdown-toggle w-100 d-flex align-items-center justify-content-start" ngbDropdownToggle type="button">
                        <i class="bi bi-flag-fill me-2" [ngStyle]="{ color: getPriorityColorValue(draft.prioridad) }"></i>
                        <span class="selected-label">{{ getPriorityLabelValue(draft.prioridad) || 'Priority' }}</span>
                      </button>
                      <div ngbDropdownMenu class="w-100">
                        <button ngbDropdownItem type="button" (click)="setDraftPriority('')">
                          <i class="bi bi-flag me-2 text-muted"></i>
                          <span translate>All</span>
                          <i class="bi bi-check ms-auto" *ngIf="!draft.prioridad"></i>
                        </button>
                        <button ngbDropdownItem type="button" *ngFor="let p of priorityOptions.slice(1)" (click)="setDraftPriority(p.key)">
                          <i class="bi bi-flag-fill me-2" [ngStyle]="{ color: p.color }"></i>
                          <span translate>{{ p.label }}</span>
                          <i class="bi bi-check ms-auto" *ngIf="draft.prioridad === p.key"></i>
                        </button>
                      </div>
                    </div>
                  </td>
                  <td>
                    <input class="input" type="date" [value]="draft.fechaInicio || ''" (input)="draft.fechaInicio = $any($event.target).value" />
                  </td>
                  <td>
                    <input class="input" type="date" [value]="draft.fechaFin || ''" (input)="draft.fechaFin = $any($event.target).value" />
                  </td>
                  <td>
                    <input class="input" type="date" [value]="draft.fechaVencimiento || ''" (input)="draft.fechaVencimiento = $any($event.target).value" />
                  </td>
                  <td>
                    <input class="input" type="number" min="0" [value]="draft.duracionHoras || 0" (input)="draft.duracionHoras = ($any($event.target).valueAsNumber ?? 0)" />
                  </td>
                  <td>
                    <input class="input" type="date" [value]="draft.fechaCreacionTarea || ''" (input)="draft.fechaCreacionTarea = $any($event.target).value" />
                  </td>
                  <td>
                    <input class="input" type="date" [value]="draft.fechaCerrada || ''" (input)="draft.fechaCerrada = $any($event.target).value" />
                  </td>
                  <td>
                    <input class="input" type="date" [value]="draft.fechaTerminada || ''" (input)="draft.fechaTerminada = $any($event.target).value" />
                  </td>
                  <td>
                    <!-- Asignado A desde TeamService -->
                    <select class="select" name="assignee" [(ngModel)]="draft.asignadoA" [ngModelOptions]="{standalone: true}">
                      <option value="">Sin asignar</option>
                      <option *ngFor="let t of teams" [value]="t.identificador">{{ t.nombres }}</option>
                    </select>
                  </td>
                  <td>
                    <input class="form-check-input" type="checkbox" [checked]="draft.facturable" (change)="draft.facturable = $any($event.target).checked" />
                  </td>
                  <td>
                    <input class="input" placeholder="Comentarios" [value]="draft.comentarios || ''" (input)="draft.comentarios = $any($event.target).value" />
                  </td>
                  <td>
                    <input class="input" placeholder="Etiqueta" [value]="draft.etiqueta || ''" (input)="draft.etiqueta = $any($event.target).value" />
                  </td>
                  <td class="actions">
                    <button class="btn-save" (click)="saveAdd()" [disabled]="!draft.nombre">Guardar</button>
                    <button class="btn-cancel" (click)="cancelAdd()">Cancelar</button>
                  </td>
                </tr>
                <tr *ngFor="let task of grouped[status.key]">
                  <ng-container *ngIf="!editing[task.identificador]; else editRow">
                    <td>
                      <button class="btn btn-link p-0" (click)="openTaskModalById(task.identificador)" title="Open details">
                        {{ task.nombre }}
                      </button>
                    </td>
                    <td>{{ task.descripcion }}</td>
                    <td>
                      {{ getStatusLabel(task.estado) }}
                    </td>
                    <td>{{ task.progreso || 0 }}%</td>
                    <td>
                      <span class="d-inline-flex align-items-center">
                        <i class="bi bi-flag-fill me-1" [ngStyle]="{ color: getPriorityColorValue(task.prioridad) }"></i>
                        {{ getPriorityLabelValue(task.prioridad) }}
                      </span>
                    </td>
                    <td>{{ task.fechaInicio }}</td>
                    <td>{{ task.fechaFin }}</td>
                    <td>{{ task.fechaVencimiento }}</td>
                    <td>{{ task.duracionHoras }}</td>
                    <td>{{ $any(task).fechaCreacionTarea }}</td>
                    <td>{{ $any(task).fechaCerrada }}</td>
                    <td>{{ $any(task).fechaTerminada }}</td>
                    <td>{{ assigneeLabel(task.asignadoA || $any(task).responsableIdentificador) }}</td>
                    <td>
                      <span class="badge bg-light text-dark" *ngIf="$any(task).facturable">Sí</span>
                      <span class="badge bg-light text-dark" *ngIf="!$any(task).facturable">No</span>
                    </td>
                    <td>{{ task.comentarios }}</td>
                    <td>{{ task.etiqueta }}</td>
                    <td>
                      <button class="btn btn-outline-primary btn-sm me-1" (click)="startEdit(task)">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button class="btn btn-outline-danger btn-sm" (click)="deleteTask(task)">
                        <i class="bi bi-trash"></i>
                      </button>
                    </td>
                  </ng-container>
                  <ng-template #editRow>
                    <td>
                      <input class="input" [value]="task.nombre" (input)="task.nombre = $any($event.target).value" />
                    </td>
                    <td>
                      <input class="input" [value]="task.descripcion || ''" (input)="task.descripcion = $any($event.target).value" />
                    </td>
                    <td>
                      <select class="select" [value]="task.estado" (change)="onStatusChange(task, $any($event.target).value)">
                        <option *ngFor="let s of statuses" [value]="s.key">{{ s.label }}</option>
                      </select>
                    </td>
                    <td>
                      <input class="input" type="number" min="0" max="100" [value]="task.progreso || 0" (input)="task.progreso = ($any($event.target).valueAsNumber ?? 0)" />
                    </td>
                    <td>
                      <div ngbDropdown class="dropdown-select w-100">
                        <button class="btn btn-select btn-sm dropdown-toggle w-100 d-flex align-items-center justify-content-start" ngbDropdownToggle type="button">
                          <i class="bi bi-flag-fill me-2" [ngStyle]="{ color: getPriorityColorValue(task.prioridad) }"></i>
                          <span class="selected-label">{{ getPriorityLabelValue(task.prioridad) || 'Priority' }}</span>
                        </button>
                        <div ngbDropdownMenu class="w-100">
                          <button ngbDropdownItem type="button" (click)="setTaskPriority(task, '')">
                            <i class="bi bi-flag me-2 text-muted"></i>
                            <span translate>All</span>
                            <i class="bi bi-check ms-auto" *ngIf="!task.prioridad"></i>
                          </button>
                          <button ngbDropdownItem type="button" *ngFor="let p of priorityOptions.slice(1)" (click)="setTaskPriority(task, p.key)">
                            <i class="bi bi-flag-fill me-2" [ngStyle]="{ color: p.color }"></i>
                            <span translate>{{ p.label }}</span>
                            <i class="bi bi-check ms-auto" *ngIf="task.prioridad === p.key"></i>
                          </button>
                        </div>
                      </div>
                    </td>
                    <td><input class="input" type="date" [value]="task.fechaInicio || ''" (input)="task.fechaInicio = $any($event.target).value" /></td>
                    <td><input class="input" type="date" [value]="task.fechaFin || ''" (input)="task.fechaFin = $any($event.target).value" /></td>
                    <td><input class="input" type="date" [value]="task.fechaVencimiento || ''" (input)="task.fechaVencimiento = $any($event.target).value" /></td>
                    <td><input class="input" type="number" min="0" [value]="task.duracionHoras || 0" (input)="task.duracionHoras = ($any($event.target).valueAsNumber ?? 0)" /></td>
                    <td><input class="input" type="date" [value]="$any(task).fechaCreacionTarea || ''" (input)="$any(task).fechaCreacionTarea = $any($event.target).value" /></td>
                    <td><input class="input" type="date" [value]="$any(task).fechaCerrada || ''" (input)="$any(task).fechaCerrada = $any($event.target).value" /></td>
                    <td><input class="input" type="date" [value]="$any(task).fechaTerminada || ''" (input)="$any(task).fechaTerminada = $any($event.target).value" /></td>
                    <td>
                      <select class="select" [value]="task.asignadoA || $any(task).responsableIdentificador || ''" (change)="task.asignadoA = $any($event.target).value; $any(task).responsableIdentificador = $any($event.target).value">
                        <option value="">Sin asignar</option>
                        <option *ngFor="let t of teams" [value]="t.identificador">{{ t.nombres }}</option>
                      </select>
                    </td>
                    <td>
                      <input class="form-check-input" type="checkbox" [checked]="$any(task).facturable" (change)="$any(task).facturable = $any($event.target).checked" />
                    </td>
                    <td>
                      <input class="input" [value]="task.comentarios || ''" (input)="task.comentarios = $any($event.target).value" />
                    </td>
                    <td>
                      <input class="input" [value]="task.etiqueta || ''" (input)="task.etiqueta = $any($event.target).value" />
                    </td>
                    <td>
                      <button class="btn btn-success btn-sm" (click)="saveEdit(task)" [disabled]="loading">
                        <i class="bi bi-check"></i>
                      </button>
                      <button class="btn btn-secondary btn-sm" (click)="cancelEdit(task)">
                        <i class="bi bi-x"></i>
                      </button>
                    </td>
                  </ng-template>
                </tr>
              </tbody>
            </table>
            </div>
          </div>
        </div>
      </div>
    </ng-container>
  </div>
</div>
<ng-template #empty>
  <div class="list-view empty">
    <p>Select a list to view details</p>
  </div>
</ng-template>

<!-- Task details modal -->
<app-modal-task
  [show]="showTaskModal"
  [tasks]="currentTasksFlat"
  [selectedIndex]="selectedTaskIndex"
  [statuses]="statuses"
  [teams]="teams"
  (close)="closeTaskModal()"
  (updateTask)="onModalTaskUpdate($event)">
</app-modal-task>
