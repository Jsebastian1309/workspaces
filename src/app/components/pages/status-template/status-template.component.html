<div class="container justify-content-center mt-4">
    <h3 translate class="text-center">Status Templates</h3>
    <div *ngIf="templatesLoading" class="d-flex justify-content-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div *ngIf="showCreateForm" class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">New Status Template</h5>
            <form [formGroup]="form" (ngSubmit)="createTemplate()">
                <div class="mb-3">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-control"
                        formControlName="nombre" required />
                </div>
                <div class="mb-3">
                    <label class="form-label">Statuses</label>
                    <div formArrayName="detalles">
                        <div class="border rounded p-2 mb-2"
                            *ngFor="let d of detalles.controls; let i = index"
                            [formGroupName]="i">
                            <div class="row g-2 align-items-end">
                                <div class="col-12 col-md-4">
                                    <label class="form-label">Name</label>
                                    <input class="form-control"
                                        placeholder="e.g. In progress"
                                        formControlName="nombre" />
                                </div>
                                <div class="col-6 col-md-2">
                                    <label class="form-label">Order</label>
                                    <input type="number" class="form-control"
                                        formControlName="secuencia" />
                                </div>
                                <div class="col-6 col-md-4">
                                    <label class="form-label">Color</label>
                                    <input type="color" class="form-control form-control-color"
                                           formControlName="color" />
                                </div>
                                <div class="col-12 col-md-2 text-end">
                                    <button type="button"
                                        class="btn btn-outline-danger"
                                        (click)="removeDetalle(i)"
                                        [disabled]="detalles.length === 1">Remove</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary"
                        (click)="addDetalle()">+ Add status</button>
                </div>
                <button type="submit" class="btn btn-success"
                    [disabled]="saving">Create</button>
                <button type="button" class="btn btn-secondary ms-2"
                    (click)="toggleCreateForm()">Cancel</button>
                <div *ngIf="saveMessage === 'success'"
                    class="text-success ms-3 d-inline-block">Saved</div>
                <div *ngIf="saveMessage === 'error'"
                    class="text-danger ms-3 d-inline-block">Save failed</div>
            </form>
        </div>
    </div>

    <div class="row">
        <div class="col-8">
            <h4>Select a Template</h4>
        </div>
        <div class="col-8">
            <button class="btn btn-primary mb-3" (click)="toggleCreateForm()">
                <i class="bi bi-plus-lg"></i> Create New Status
            </button>
        </div>
        <hr>

        <div *ngFor="let template of templates" class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <div
                        *ngIf="editingTemplate === template.identificador; else viewTpl">
                        <form (ngSubmit)="saveEdit(template)">
                            <div class="mb-3">
                                <label class="form-label">Name</label>
                                <input type="text" class="form-control"
                                    [(ngModel)]="editTemplate.nombre"
                                    name="editNombre_{{template.identificador}}"
                                    required />
                            </div>
                            <button type="submit"
                                class="btn btn-success btn-sm">Save</button>
                            <button type="button"
                                class="btn btn-secondary btn-sm ms-2"
                                (click)="cancelEdit()">Cancel</button>
                        </form>
                    </div>
                    <!-- View Mode -->
                    <ng-template #viewTpl>
                        <h5 class="card-title">{{ template.nombre }}</h5>
                        <button class="btn btn-info btn-sm me-2"
                            (click)="selectTemplate(template)">View
                            Details</button>
                        <button class="btn btn-warning btn-sm me-2"
                            (click)="startEdit(template)">Edit</button>
                        <button class="btn btn-danger btn-sm"
                            (click)="deleteTemplate(template)">Delete</button>
                    </ng-template>
                </div>
            </div>
        </div>
    </div>
    <hr>
    <div *ngIf="selectedTemplate" class="mt-4">
        <div class="d-flex justify-content-between align-items-center mb-2 details-toolbar">
            <h3 class="m-0" translate>Template States {{ selectedTemplate.nombre }}</h3>
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-outline-primary btn-sm" (click)="startAddDetail()" title="Add status">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </div>
        </div>

        <!-- Inline add form for new detail -->
        <div *ngIf="addingDetail" class="card card-body p-3 mb-3">
            <form (ngSubmit)="saveNewDetail()">
                <div class="row g-2 align-items-end">
                    <div class="col-12 col-md-5">
                        <label class="form-label">Name</label>
                        <input class="form-control form-control-sm"
                               placeholder="e.g. In progress"
                               [(ngModel)]="newDetail.nombre"
                               [ngModelOptions]="{standalone: true}" required />
                    </div>
                    <div class="col-6 col-md-2">
                        <label class="form-label">Order</label>
                        <input type="number" class="form-control form-control-sm"
                               [(ngModel)]="newDetail.secuencia"
                               [ngModelOptions]="{standalone: true}" required />
                    </div>
                    <div class="col-6 col-md-3">
                        <label class="form-label">Color</label>
                        <input type="color" class="form-control form-control-color"
                               [(ngModel)]="newDetail.color" [ngModelOptions]="{standalone: true}" />
                    </div>
                    <div class="col-12 col-md-2 text-end">
                        <button type="submit" class="btn btn-success btn-sm me-1">Save</button>
                        <button type="button" class="btn btn-secondary btn-sm" (click)="cancelAddDetail()">Cancel</button>
                    </div>
                </div>
            </form>
        </div>

        <table class="table table-hover align-middle mt-2">
            <thead>
                <tr>
                    <th translate>sequence</th>
                    <th translate>Name</th>
                    <th translate>Color</th>
                    <th translate>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let detail of selectedDetails">
                    <td>
                        <ng-container *ngIf="editingDetailId === detail.identificador; else seqView">
                            <input type="number" class="form-control form-control-sm"
                                   [(ngModel)]="editDetail.secuencia" [ngModelOptions]="{standalone: true}" />
                        </ng-container>
                        <ng-template #seqView>{{ detail.secuencia }}</ng-template>
                    </td>
                    <td>
                        <ng-container *ngIf="editingDetailId === detail.identificador; else nameView">
                            <input class="form-control form-control-sm"
                                   [(ngModel)]="editDetail.nombre" [ngModelOptions]="{standalone: true}" />
                        </ng-container>
                        <ng-template #nameView>{{ detail.nombre }}</ng-template>
                    </td>
                    <td>
                        <ng-container *ngIf="editingDetailId === detail.identificador; else colorView">
                            <label class="visually-hidden">Color</label>
                            <input type="color" class="form-control form-control-color"
                                   [(ngModel)]="editDetail.color" [ngModelOptions]="{standalone: true}" />
                        </ng-container>
                        <ng-template #colorView>
                            <span class="badge" [style.background]="detail.color"
                                  style="width:16px;height:16px;border-radius:4px;display:inline-block;">&nbsp;</span>
                        </ng-template>
                    </td>
                    <td class="text-nowrap">
                        <ng-container *ngIf="editingDetailId === detail.identificador; else actionsView">
                            <button class="btn btn-success btn-sm" (click)="saveEditDetail(detail)">Save</button>
                            <button class="btn btn-secondary btn-sm ms-1" (click)="cancelEditDetail()">Cancel</button>
                        </ng-container>
                        <ng-template #actionsView>
                            <button class="btn btn-outline-secondary btn-sm" (click)="startEditDetail(detail)" title="Edit"><i class="bi bi-pencil-square"></i></button>
                            <button class="btn btn-outline-danger btn-sm ms-1" (click)="deleteDetail(detail)" title="Delete"><i class="bi bi-trash"></i></button>
                        </ng-template>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
