<!-- Modal Header -->
<div class="modal-header">
	<h5 class="modal-title" translate>Template Tasks {{ templateName }}</h5>
	<button type="button" class="btn btn-sm close-btn ms-auto" (click)="close()"
		aria-label="Close"><i class="bi bi-x-lg"></i></button>
</div>

<!-- Modal Body -->
<div class="modal-body">
	<!-- Loading state: centered icon covering body -->
	<div *ngIf="loading" class="loading-container">
		<i class="bi bi-arrow-clockwise loading-icon"></i>
	</div>

	<!-- Content only when not loading -->
	<div *ngIf="!loading">
		<div class="d-flex justify-content-between align-items-center mb-2">
			<div class="text-danger" *ngIf="error">{{ error }}</div>
			<button class="btn btn-primary btn-sm ms-auto" (click)="startAdd()"
				[disabled]="adding || editingId" title="Agregar tarea">Add New Task<i
					class="bi bi-plus-lg"></i>
			</button>
		</div>

	<!-- Add New Task Form -->
	<div *ngIf="adding" class="card card-body p-3 mb-3">
		<div class="row g-2 align-items-end">
			<div class="col-12 col-md-4">
				<label translate class="form-label">Name</label>
				<input class="form-control form-control-sm" [(ngModel)]="newDetail.nombre"
					[ngModelOptions]="{standalone: true}" />
			</div>
      <div class="col-12 col-md-3">
				<label translate class="form-label">Label</label>
				<input class="form-control form-control-sm" [(ngModel)]="newDetail.etiqueta"
					[ngModelOptions]="{standalone: true}" />
			</div>
			<div class="col-6 col-md-3">
				<label translate class="form-label">Priority</label>
        <div ngbDropdown>
          <button class="btn btn-sm btn-outline-secondary dropdown-toggle" ngbDropdownToggle>
            <i class="bi bi-flag-fill" [ngStyle]="{ color: getPriorityColorValue(newDetail.prioridad) }"></i>
            {{ getPriorityLabelValue(newDetail.prioridad) }}
          </button>
          <div ngbDropdownMenu>
            <button *ngFor="let p of priorityOptions" ngbDropdownItem (click)="newDetail.prioridad = p.key">
              <i class="bi bi-flag-fill" [ngStyle]="{ color: p.color }"></i> {{ p.label }}
            </button>
          </div>
        </div>
			</div>
      <div class="col-6 col-md-2">
        <label translate class="form-label">Duration (h)</label>
        <input type="number" class="form-control form-control-sm" [(ngModel)]="newDetail.duracionHoras"
          [ngModelOptions]="{standalone: true}" />
      </div>
      <div class="col-12">
        <label translate class="form-label">Description</label>
        <textarea class="form-control form-control-sm" [(ngModel)]="newDetail.descripcion"
          [ngModelOptions]="{standalone: true}"></textarea>
      </div>
      <div class="col-12">
        <label translate class="form-label">Comments</label>
        <textarea class="form-control form-control-sm" [(ngModel)]="newDetail.comentarios"
          [ngModelOptions]="{standalone: true}"></textarea>
      </div>
			<div class="col-12 text-end">
				<button class="btn btn-success btn-sm me-1"
					(click)="saveNew()">Save</button>
				<button class="btn btn-danger btn-sm" (click)="cancelAdd()">Cancel</button>
			</div>
		</div>
	</div>


	<!-- Template Tasks Table -->
	<table class="table  align-middle mt-2 table-surface">
		<thead>
			<tr>
				<th translate>Name</th>
        <th translate>Label</th>
				<th translate>Priority</th>
        <th translate>Duration (h)</th>
        <th translate>Description</th>
        <th translate>Comments</th>
				<th translate>Actions</th>
			</tr>
		</thead>
		<tbody>
			<tr *ngFor="let d of details; let i = index">
				<td>
					<ng-container *ngIf="editingId === d.identificador; else nameView">
						<input class="form-control form-control-sm"
							[(ngModel)]="editDetail.nombre" [ngModelOptions]="{standalone: true}" />
					</ng-container>
					<ng-template #nameView>{{ d.nombre }}</ng-template>
				</td>
        <td>
					<ng-container *ngIf="editingId === d.identificador; else labelView">
						<input class="form-control form-control-sm"
							[(ngModel)]="editDetail.etiqueta" [ngModelOptions]="{standalone: true}" />
					</ng-container>
					<ng-template #labelView>{{ d.etiqueta }}</ng-template>
				</td>
				<td>
					<ng-container *ngIf="editingId === d.identificador; else priorityView">
            <div ngbDropdown>
              <button class="btn btn-sm btn-outline-secondary dropdown-toggle" ngbDropdownToggle>
                <i class="bi bi-flag-fill" [ngStyle]="{ color: getPriorityColorValue(editDetail.prioridad) }"></i>
                {{ getPriorityLabelValue(editDetail.prioridad) }}
              </button>
              <div ngbDropdownMenu>
                <button *ngFor="let p of priorityOptions" ngbDropdownItem (click)="editDetail.prioridad = p.key">
                  <i class="bi bi-flag-fill" [ngStyle]="{ color: p.color }"></i> {{ p.label }}
                </button>
              </div>
            </div>
					</ng-container>
					<ng-template #priorityView>
						<span class="badge" [ngStyle]="{ 'background-color': getPriorityColorValue(d.prioridad) }">
              {{ getPriorityLabelValue(d.prioridad) }}
            </span>
					</ng-template>
				</td>
        <td>
          <ng-container *ngIf="editingId === d.identificador; else durationView">
            <input type="number" class="form-control form-control-sm"
              [(ngModel)]="editDetail.duracionHoras" [ngModelOptions]="{standalone: true}" />
          </ng-container>
          <ng-template #durationView>{{ d.duracionHoras }}</ng-template>
        </td>
        <td>
          <ng-container *ngIf="editingId === d.identificador; else descriptionView">
            <textarea class="form-control form-control-sm"
              [(ngModel)]="editDetail.descripcion" [ngModelOptions]="{standalone: true}"></textarea>
          </ng-container>
          <ng-template #descriptionView>{{ d.descripcion }}</ng-template>
        </td>
        <td>
          <ng-container *ngIf="editingId === d.identificador; else commentsView">
            <textarea class="form-control form-control-sm"
              [(ngModel)]="editDetail.comentarios" [ngModelOptions]="{standalone: true}"></textarea>
          </ng-container>
          <ng-template #commentsView>{{ d.comentarios }}</ng-template>
        </td>
				<td class="text-nowrap">
					<ng-container *ngIf="editingId === d.identificador; else actionsView">
						<button class="btn btn-success btn-sm"
							(click)="saveEdit()">Aplicar</button>
						<button class="btn btn-secondary btn-sm ms-1"
							(click)="cancelEdit()">Cancelar</button>
					</ng-container>
					<ng-template #actionsView>
						<button class="btn btn-secondary btn-sm" (click)="startEdit(d)"
							title="Editar"><i class="bi bi-pencil-square"></i></button>
						<button class="btn btn-danger btn-sm ms-1" (click)="delete(d)"
							title="Eliminar"><i class="bi bi-trash"></i></button>
					</ng-template>
				</td>
			</tr>
		</tbody>
	</table>
	</div>
</div>
<div class="modal-footer">
	<button type="button" class="btn btn-secondary"
		(click)="close()">Cancelar</button>
</div>
