<div class="wt-modal" [class.show]="show" [style.display]="show ? 'block' : 'none'" (click)="onBackdropClick($event)">
	<div class="wt-modal-dialog" role="dialog" aria-modal="true">
		<div class="wt-modal-content" (click)="$event.stopPropagation()">
			<div class="wt-modal-header">
				<div class="left">
					<button class="btn-nav" [disabled]="!hasPrev" (click)="prev()" aria-label="Previous task">
						<i class="bi bi-chevron-left"></i>
					</button>
					<button class="btn-nav" [disabled]="!hasNext" (click)="next()" aria-label="Next task">
						<i class="bi bi-chevron-right"></i>
					</button>
				</div>
				<div class="title" *ngIf="task as t">
					{{ isCreateMode ? 'Nueva Tarea' : (t.nombre || 'Untitled task') }}
				</div>
				<div class="right">
					<button class="btn-close" (click)="close.emit()" aria-label="Close">
						<i class="bi bi-x"></i>
					</button>
				</div>
			</div>

			<div class="wt-modal-body" *ngIf="task as t">
				<div class="pane left">
					<fieldset [disabled]="!canEdit" class="edit-fieldset">
					<div class="form-group">
						<label>Nombre</label>
						<input class="form-control" [value]="t.nombre || ''" (input)="onFieldChange('nombre', $any($event.target).value)" />
					</div>
					<div class="form-group">
						<label>Descripción</label>
						<textarea class="form-control" rows="3" [value]="t.descripcion || ''" (input)="onFieldChange('descripcion', $any($event.target).value)"></textarea>
					</div>

					<div class="row g-2">
						<div class="col-6">
							<label>Estado</label>
							<select class="form-select" [value]="t.estado" (change)="onFieldChange('estado', $any($event.target).value)">
								<option *ngFor="let s of statuses" [value]="s.key">{{ s.label }}</option>
							</select>
						</div>
						<div class="col-6">
							<label>Progreso (%)</label>
							<input class="form-control" type="number" min="0" max="100" [value]="t.progreso || 0" (input)="onFieldChange('progreso', ($any($event.target).valueAsNumber ?? 0))" />
						</div>
					</div>

					<div class="row g-2 mt-2">
						<div class="col-6">
							<label>Prioridad</label>
							<div ngbDropdown class="dropdown-select w-100">
								<button class="btn btn-select btn-sm dropdown-toggle w-100 d-flex align-items-center justify-content-start" ngbDropdownToggle type="button">
									<i class="bi bi-flag-fill me-2" [ngStyle]="{ color: getPriorityColor(t.prioridad) }"></i>
									<span class="selected-label">{{ getPriorityLabel(t.prioridad) || 'Prioridad' }}</span>
								</button>
								<div ngbDropdownMenu class="w-100">
									<button ngbDropdownItem type="button" (click)="onFieldChange('prioridad', '')">
										<i class="bi bi-flag me-2 text-muted"></i>
										<span>Ninguna</span>
										<i class="bi bi-check ms-auto" *ngIf="!t.prioridad"></i>
									</button>
									<button ngbDropdownItem type="button" (click)="onFieldChange('prioridad', 'urgente')">
										<i class="bi bi-flag-fill me-2" style="color:#e53935"></i>
										<span>Urgente</span>
										<i class="bi bi-check ms-auto" *ngIf="t.prioridad === 'urgente'"></i>
									</button>
									<button ngbDropdownItem type="button" (click)="onFieldChange('prioridad', 'alta')">
										<i class="bi bi-flag-fill me-2" style="color:#f6c343"></i>
										<span>Alta</span>
										<i class="bi bi-check ms-auto" *ngIf="t.prioridad === 'alta'"></i>
									</button>
									<button ngbDropdownItem type="button" (click)="onFieldChange('prioridad', 'normal')">
										<i class="bi bi-flag-fill me-2" style="color:#4f75ff"></i>
										<span>Normal</span>
										<i class="bi bi-check ms-auto" *ngIf="t.prioridad === 'normal'"></i>
									</button>
									<button ngbDropdownItem type="button" (click)="onFieldChange('prioridad', 'baja')">
										<i class="bi bi-flag-fill me-2" style="color:#9e9e9e"></i>
										<span>Baja</span>
										<i class="bi bi-check ms-auto" *ngIf="t.prioridad === 'baja'"></i>
									</button>
								</div>
							</div>
						</div>
						<div class="col-6">
							<label>Duración (Tiempo Estimado en Horas)</label>
							<input class="form-control" type="number" min="0" [value]="t.duracionHoras || 0" (input)="onFieldChange('duracionHoras', ($any($event.target).valueAsNumber ?? 0))" />
						</div>
					</div>

					<div class="row g-2 mt-2">
						<div class="col-6">
							<label>Fecha Inicio</label>
							<input class="form-control" type="date" [value]="t.fechaInicio || ''" (input)="onFieldChange('fechaInicio', $any($event.target).value)" />
						</div>
						<div class="col-6">
							<label>Fecha Fin</label>
							<input class="form-control" type="date" [value]="t.fechaFin || ''" (input)="onFieldChange('fechaFin', $any($event.target).value)" />
						</div>
					</div>
					<div class="row g-2 mt-2">
						<div class="col-6">
							<label>Fecha Vencimiento</label>
							<input class="form-control" type="date" [value]="t.fechaVencimiento || ''" (input)="onFieldChange('fechaVencimiento', $any($event.target).value)" />
						</div>
					</div>
					<!-- <div class="row g-2 mt-2">
						<div class="col-6">	
							<label>Fecha Cerrada</label>
							<input class="form-control" type="date" [value]="$any(t).fechaCerrada || ''" (input)="onFieldChange('fechaCerrada', $any($event.target).value)" />
						</div>
						<div class="col-6">
							<label>Fecha Terminada</label>
							<input class="form-control" type="date" [value]="$any(t).fechaTerminada || ''" (input)="onFieldChange('fechaTerminada', $any($event.target).value)" />
						</div>
					</div> -->

					<div class="row g-2 mt-2">
						<div class="col-6">
							<label>Asignado A</label>
							<select class="form-select" [value]="t.asignadoA || $any(t).responsableIdentificador || ''" (change)="onFieldChange('asignadoA', $any($event.target).value); onFieldChange('responsableIdentificador', $any($event.target).value)">
								<option value="">Sin asignar</option>
								<option *ngFor="let tm of teams" [value]="tm.identificador">{{ tm.nombres || tm.nombre }}</option>
							</select>
						</div>
						<div class="col-6 d-flex align-items-end">
							<div class="form-check mt-3">
								<input class="form-check-input" type="checkbox" id="facturableChk" [checked]="$any(t).facturable" (change)="onFieldChange('facturable', $any($event.target).checked)" />
								<label class="form-check-label" for="facturableChk">Facturable</label>
							</div>
						</div>
					</div>

					<div class="row g-2 mt-2">
						<div class="col-6">
							<label>Etiqueta</label>
							<input class="form-control" [value]="t.etiqueta || ''" (input)="onFieldChange('etiqueta', $any($event.target).value)" />
						</div>
						<div class="col-6">
							<label>Tipo Tarea</label>
							<select class="form-select" [value]="t.tipoTarea || 'TASK'" (change)="onFieldChange('tipoTarea', $any($event.target).value)">
								<option value="TASK">Tarea</option>
							</select>
						</div>
					</div>

					<div class="row g-2 mt-2">
						<div class="col-6">
							<label>Localización</label>
							<input class="form-control" [value]="$any(t).localizacion || ''" (input)="onFieldChange('localizacion', $any($event.target).value)" />
						</div>
					</div>

					<div class="row g-2 mt-2">
						<div class="col-6">
							<label>Hora Inicio</label>
							<input class="form-control" type="time" [value]="$any(t).horaInicio || ''" (input)="onFieldChange('horaInicio', $any($event.target).value)" />
						</div>
						<div class="col-6">
							<label>Hora Fin</label>
							<input class="form-control" type="time" [value]="$any(t).horaFin || ''" (input)="onFieldChange('horaFin', $any($event.target).value)" />
						</div>
					</div>

					<div class="row g-2 mt-2">
						<div class="col-6">
							<label>Timezone</label>
							<select class="form-select" [value]="$any(t).timezone || 'UTC-5'" (change)="onFieldChange('timezone', $any($event.target).value)">
								<option value="UTC-5">UTC-5 (Colombia)</option>
							</select>
						</div>
						<div class="col-6">
							<label>Tipo Notificación</label>
							<select class="form-select" [value]="$any(t).tipoNotificacion || ''" (change)="onFieldChange('tipoNotificacion', $any($event.target).value)">
								<option value="">Sin notificación</option>
								<option value="EMAIL">Email</option>
								<option value="SMS">SMS</option>
								<option value="WhatsApp">WhatsApp</option>
							</select>
						</div>
					</div>

					<div class="row g-2 mt-2">
						<div class="col-6">
							<label>Minutos Notificación</label>
							<input class="form-control" type="number" min="0" [value]="$any(t).minutosNotificacion || 0" (input)="onFieldChange('minutosNotificacion', ($any($event.target).valueAsNumber ?? 0))" />
						</div>
					</div>

					<div class="form-group mt-2">
						<label>Comentarios</label>
						<textarea class="form-control" rows="3" [value]="t.comentarios || ''" (input)="onFieldChange('comentarios', $any($event.target).value)"></textarea>
					</div>
					</fieldset>
				</div>

				<div class="pane right">
					<div class="activity-header">Bitácora</div>
					<div class="activity-list">
						<div class="empty" *ngIf="!task">No task selected</div>
						<!-- Loading state -->
						<div class="loading text-center" *ngIf="task && auditLoading">
							<i class="bi bi-arrow-clockwise"></i>
						</div>
						<!-- Error state -->
						<div class="text-danger small" *ngIf="auditError">{{ auditError }}</div>
						<!-- Items -->
						<ul class="list-unstyled" *ngIf="task && !auditLoading && !auditError && audit.length > 0">
							<li *ngFor="let a of audit; trackBy: trackByAuditId">
								<div class="item">
									<div class="title">
										<strong>{{ a.tipoOperacion || 'CAMBIO' }}</strong>
										<span *ngIf="a.campoModificado"> · {{ a.campoModificado }}</span>
									</div>
									<div class="meta text-muted small">
										{{ a.fechaModificacion || '' }} · {{ a.usuarioModificacion || '' }}
									</div>
									<div class="diff small" *ngIf="a.valorAnterior != null || a.valorNuevo != null">
										<span class="text-muted">{{ a.valorAnterior }}</span>
										<i class="bi bi-arrow-right mx-1"></i>
										<span>{{ a.valorNuevo }}</span>
									</div>
									<div class="desc" *ngIf="a.descripcionCambio">{{ a.descripcionCambio }}</div>
								</div>
							</li>
						</ul>
						<!-- Empty state when no items -->
						<div class="empty" *ngIf="task && !auditLoading && !auditError && audit.length === 0">No activity yet</div>
					</div>
				</div>
			</div>

			<div class="wt-modal-footer">
				<!-- Error message -->
				<div class="alert alert-danger small mb-2" *ngIf="saveError">
					{{ saveError }}
				</div>
				
				<div class="d-flex gap-2 ms-auto">
					<button *ngIf="!isCreateMode && !canEdit" class="btn btn-outline-secondary" (click)="enableEdit()">
						<i class="bi bi-pencil"></i>
						<span class="ms-1">Editar</span>
					</button>
					<button *ngIf="!isCreateMode && canEdit" class="btn btn-success" (click)="saveExistingTask()" [disabled]="!task?.nombre || saveLoading">
						<i class="bi bi-arrow-clockwise" *ngIf="saveLoading"></i>
						<i class="bi bi-check" *ngIf="!saveLoading"></i>
						<span class="ms-1">{{ saveLoading ? 'Guardando...' : 'Guardar Cambios' }}</span>
					</button>
					<button *ngIf="isCreateMode" class="btn btn-primary" (click)="saveNewTask()" [disabled]="!task?.nombre">
						<i class="bi bi-check"></i>
						<span class="ms-1">Crear Tarea</span>
					</button>
					<button class="btn btn-primary-nav" (click)="close.emit()" [disabled]="saveLoading">
						{{ isCreateMode ? 'Cancelar' : 'Cerrar' }}
					</button>
				</div>
			</div>
		</div>
	</div>
</div>
