<div class="container py-3">
	<!-- Step Indicator -->
	<h4 translate class="mb-3">Create States Template</h4>
	<div class="d-flex align-items-center gap-2 mb-3">
		<div
			[class]="'badge rounded-pill ' + (step === 1 ? 'bg-primary' : 'bg-secondary')">1</div>
		<div translate [class.fw-bold]="step === 1">Header</div>
		<div class="mx-2">→</div>
		<div
			[class]="'badge rounded-pill ' + (step === 2 ? 'bg-primary' : 'bg-secondary')">2</div>
		<div translate [class.fw-bold]="step === 2">Details</div>
	</div>

	<!-- Server Message -->
	<div *ngIf="serverMessage" class="alert"
		[ngClass]="{'alert-success': serverMessage.type === 'success','alert-danger': serverMessage.type === 'error'}">{{
		serverMessage.text }}</div>

	<!-- Step Forms -->
	<!-- Step 1: Header Form -->
	<form *ngIf="step === 1" [formGroup]="headerForm" (ngSubmit)="submitHeader()"
		class="card p-3">
		<div class="mb-3">
			<label translate class="form-label">Template name</label>
			<input type="text" class="form-control" formControlName="nombre" [placeholder]="'Eg: Status flow for tasks' | translate" />
			<div translate class="text-danger small" *ngIf="headerForm.get('nombre')?.touched && headerForm.get('nombre')?.errors?.['required']">
				Name is required.
			</div>
			<div translate class="text-danger small" *ngIf="headerForm.get('nombre')?.touched && headerForm.get('nombre')?.errors?.['maxlength']">
				Maximum 15 characters allowed.
			</div>
		</div>
		<div class="d-flex justify-content-end gap-2">
			<button translate type="button" class="btn btn-danger" (click)="cancelWizard()">Cancel</button>
			<button translate type="submit" class="btn btn-primary">Keep</button>
		</div>
	</form>

	<!-- Step 2: Details Form -->
	<div *ngIf="step === 2" class="card p-3">
		<div class="d-flex justify-content-between align-items-center mb-2">
			<h6 class="m-0">States</h6>
			<div class="d-flex gap-2">
				<button translate class="btn btn-secondary"
					(click)="backToHeader()">Return</button>
				<button translate class="btn btn-primary" (click)="addDetail()">Add
					State</button>

			</div>
		</div>

				<table class="table table-surface mt-2" cdkDropList (cdkDropListDropped)="drop($event)" *ngIf="detailsFormArray.length > 0">
			<thead>
				<tr>
					<th style="width: 32px;"></th>
					<th translate>Name</th>
					<th translate>Color</th>
					<th translate>Actions</th>
				</tr>
			</thead>
			<tbody >
				<tr *ngFor="let g of detailsControls; let i = index" [formGroup]="g" cdkDrag>
					<td cdkDragHandle><i class="bi bi-grip-vertical"></i></td>
					<td>
						<input class="form-control form-control-sm" formControlName="nombre" placeholder="Ej: Nuevo, En progreso, Hecho" />
						<div class="text-danger small" *ngIf="g.get('nombre')?.touched && g.get('nombre')?.invalid">
							Requerido.
						</div>
					</td>
					<td>
						<input class="form-control form-control-sm form-control-color" formControlName="color" type="color" />
					</td>
					<td class="text-nowrap">
						<button type="button" class="btn btn-danger btn-sm" title="Eliminar" (click)="removeDetail(i)">
							<i class="bi bi-trash"></i>
						</button>
					</td>
				</tr>
			</tbody>
		</table>

		<div *ngIf="detailsFormArray.length === 0" class="text-center text-muted my-3">
			<span translate>No states added yet. Click 'Add State' to begin.</span>
		</div>

		<div class="d-flex justify-content-end">
							<button translate class="btn btn-danger"
					(click)="cancelWizard()">Cancel</button>
			<button class="btn btn-primary" (click)="saveDetails()"
				[disabled]="isSubmittingDetails">
				{{ isSubmittingDetails ? 'Guardando…' : 'Guardar todo' }}
			</button>
		</div>
	</div>
</div>
