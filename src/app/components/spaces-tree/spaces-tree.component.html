<div class="spaces-tree-container">
  <!-- Header del tree con botón de agregar space -->
  <div class="tree-header">
    <div class="d-flex justify-content-between align-items-center">
      <span class="section-title">Spaces</span>
      <button 
        mat-icon-button 
        class="add-space-btn" 
        (click)="onAddSpace()"
        title="Add Space"
        *ngIf="espacioTrabajoSeleccionado">
        <mat-icon>add</mat-icon>
      </button>
    </div>
  </div>

  <!-- Mensaje cuando no hay workspace seleccionado -->
  <div class="no-workspace" *ngIf="!espacioTrabajoSeleccionado">
    <mat-icon class="empty-icon">work_outline</mat-icon>
    <p>Select a workspace to view spaces</p>
  </div>

  <!-- Loading indicator -->
  <div class="loading-spaces" *ngIf="espacioTrabajoSeleccionado && isLoading">
    <mat-icon class="loading-icon">refresh</mat-icon>
    <p>Loading spaces...</p>
  </div>

  <!-- Tree de spaces -->
  <mat-tree 
    [dataSource]="dataSource" 
    [treeControl]="treeControl" 
    class="spaces-tree"
    *ngIf="espacioTrabajoSeleccionado && !isLoading">
    
    <!-- Nodo con hijos (spaces y folders) -->
    <mat-tree-node 
      *matTreeNodeDef="let node; when: hasChild" 
      matTreeNodeToggle
      [attr.aria-label]="'toggle ' + node.nombre"
      class="tree-node"
      [ngClass]="getNodeClass(node)">
      
      <div class="node-content" (click)="onNodeClick(node)">
        <!-- Botón de expand/collapse -->
        <button 
          mat-icon-button 
          matTreeNodeToggle
          class="toggle-btn"
          [attr.aria-label]="'toggle ' + node.nome">
          <mat-icon class="mat-icon-rtl-mirror">
            {{treeControl.isExpanded(node) ? 'expand_more' : 'chevron_right'}}
          </mat-icon>
        </button>

        <!-- Icono del nodo -->
        <div class="node-icon" [style.background-color]="node.color">
          <mat-icon *ngIf="node.tipo !== 'space'" [fontIcon]="getNodeIcon(node)"></mat-icon>
          <span *ngIf="node.tipo === 'space'" class="space-avatar">{{ node.icono }}</span>
        </div>

        <!-- Nombre del nodo -->
        <span class="node-name">{{ node.nombre }}</span>

        <!-- Botones de acción -->
        <div class="node-actions" (click)="$event.stopPropagation()">
          <!-- Botón agregar (solo para spaces y folders) -->
          <button 
            mat-icon-button 
            class="action-btn add-btn"
            *ngIf="node.tipo === 'space' || node.tipo === 'folder'"
            [matMenuTriggerFor]="addMenu"
            title="Add item">
            <mat-icon>add</mat-icon>
          </button>

          <!-- Menu de agregar -->
          <mat-menu #addMenu="matMenu">
            <button mat-menu-item (click)="onAddFolder(node)" *ngIf="node.tipo === 'space'">
              <mat-icon>folder</mat-icon>
              <span>Add Folder</span>
            </button>
            <button mat-menu-item (click)="onAddTask(node)">
              <mat-icon>task_alt</mat-icon>
              <span>Add Task</span>
            </button>
          </mat-menu>

          <!-- Botón de más opciones -->
          <button 
            mat-icon-button 
            class="action-btn more-btn"
            [matMenuTriggerFor]="moreMenu"
            title="More options">
            <mat-icon>more_horiz</mat-icon>
          </button>

          <!-- Menu de más opciones -->
          <mat-menu #moreMenu="matMenu">
            <button mat-menu-item (click)="onEditNode(node)">
              <mat-icon>edit</mat-icon>
              <span>Edit</span>
            </button>
            <button mat-menu-item (click)="onDeleteNode(node)" class="delete-option">
              <mat-icon>delete</mat-icon>
              <span>Delete</span>
            </button>
          </mat-menu>
        </div>
      </div>
    </mat-tree-node>

    <!-- Nodo sin hijos (tasks) -->
    <mat-tree-node 
      *matTreeNodeDef="let node" 
      class="tree-node"
      [ngClass]="getNodeClass(node)">
      
      <div class="node-content" (click)="onNodeClick(node)">
        <!-- Espaciado para alineación -->
        <div class="toggle-spacer"></div>

        <!-- Icono del nodo -->
        <div class="node-icon">
          <mat-icon [fontIcon]="getNodeIcon(node)"></mat-icon>
        </div>

        <!-- Nombre del nodo -->
        <span class="node-name">{{ node.nombre }}</span>

        <!-- Botones de acción -->
        <div class="node-actions" (click)="$event.stopPropagation()">
          <!-- Botón de más opciones -->
          <button 
            mat-icon-button 
            class="action-btn more-btn"
            [matMenuTriggerFor]="taskMenu"
            title="More options">
            <mat-icon>more_horiz</mat-icon>
          </button>

          <!-- Menu de opciones para tasks -->
          <mat-menu #taskMenu="matMenu">
            <button mat-menu-item (click)="onEditNode(node)">
              <mat-icon>edit</mat-icon>
              <span>Edit</span>
            </button>
            <button mat-menu-item (click)="onDeleteNode(node)" class="delete-option">
              <mat-icon>delete</mat-icon>
              <span>Delete</span>
            </button>
          </mat-menu>
        </div>
      </div>
    </mat-tree-node>
  </mat-tree>

  <!-- Mensaje cuando no hay spaces -->
  <div class="empty-spaces" *ngIf="espacioTrabajoSeleccionado && !isLoading && dataSource.data.length === 0">
    <mat-icon class="empty-icon">folder_open</mat-icon>
    <p>No spaces yet</p>
    <button mat-raised-button color="primary" (click)="onAddSpace()">
      <mat-icon>add</mat-icon>
      Create your first space
    </button>
  </div>
</div>
